# ğŸ“‹ API de Leads - Navegnet - DocumentaÃ§Ã£o Completa

## ğŸ—ï¸ **Arquitetura da API**

A API de leads da Navegnet Ã© construÃ­da em **Next.js 14** com **Prisma ORM** e possui **3 endpoints principais** para diferentes cenÃ¡rios de uso:

---

## ğŸŒ **Endpoint 1: POST /api/leads (Acesso Normal)**

**MÃ©todo:** `POST`  
**Content-Type:** `application/json`  
**Uso:** AplicaÃ§Ãµes web, formulÃ¡rios normais

### **Dados ObrigatÃ³rios:**
```json
{
  "name": "string",           // Nome completo do usuÃ¡rio
  "whatsapp": "string",       // NÃºmero do WhatsApp
  "address": "string",        // EndereÃ§o completo
  "city": "string",           // Cidade
  "partnerId": "string"       // ID do parceiro
}
```

### **Dados Opcionais (VerificaÃ§Ã£o Social):**
```json
{
  "verified": "boolean",              // VerificaÃ§Ã£o geral
  "instagram_verified": "boolean",    // Seguiu no Instagram
  "google_verified": "boolean",       // Avaliou no Google
  "social_status": "string",          // Status das aÃ§Ãµes sociais
  "actions_completed": "array",       // Lista de aÃ§Ãµes completadas
  "social_score": "number",           // PontuaÃ§Ã£o (0-2)
  "lead_status": "string",            // Status do lead
  "completion_percentage": "number",  // Porcentagem de conclusÃ£o
  "social_action_type": "string",     // Tipo de aÃ§Ã£o social
  "social_action_status": "string",   // Status da aÃ§Ã£o social
  "update_type": "string",            // Tipo de atualizaÃ§Ã£o
  "is_update": "boolean",             // Ã‰ uma atualizaÃ§Ã£o?
  "lead_identifier": "string",        // Identificador Ãºnico (WhatsApp)
  "session_id": "string"              // ID da sessÃ£o
}
```

---

## ğŸŒ **Endpoint 2: GET /api/leads (Hotspot Mikrotik)**

**MÃ©todo:** `GET`  
**Uso:** Captive portal Mikrotik, fallback quando POST falha  
**Funcionamento:** Retorna imagem 1x1 transparente (PNG base64)

### **ParÃ¢metros de Query:**
```
?name=JoÃ£o&whatsapp=11999999999&address=Rua A&city=SP&partnerId=hotspot-mk&verified=true&instagram_verified=true&google_verified=true
```

### **CaracterÃ­sticas Especiais:**
- âœ… **Sempre retorna sucesso** (imagem PNG)
- âœ… **Cria parceiro automaticamente** se nÃ£o existir
- âœ… **Funciona offline** (captive portal)
- âœ… **CompatÃ­vel com Mikrotik** (mÃ©todo GET)

---

## ğŸ”„ **Endpoint 3: PATCH /api/leads/[id]/social (AtualizaÃ§Ã£o Social)**

**MÃ©todo:** `PATCH`  
**Uso:** Atualizar verificaÃ§Ãµes sociais de leads existentes  
**URL:** `/api/leads/{leadId}/social`

### **Dados Aceitos:**
```json
{
  "action": "instagram|google",       // AÃ§Ã£o simples (legado)
  "instagram_verified": "boolean",    // Seguiu no Instagram
  "google_verified": "boolean",       // Avaliou no Google
  "verified": "boolean",              // VerificaÃ§Ã£o geral
  "social_status": "string",          // Status social
  "lead_status": "string",            // Status do lead
  "social_score": "number",           // PontuaÃ§Ã£o social
  "completion_percentage": "number"   // Porcentagem de conclusÃ£o
}
```

---

## ğŸ—„ï¸ **Mapeamento para o Banco de Dados**

### **Tabela: `Lead`**

| Campo Frontend | Campo Banco | Tipo | DescriÃ§Ã£o |
|----------------|-------------|------|-----------|
| `name` | `name` | String | Nome completo |
| `whatsapp` | `whatsapp` | String | NÃºmero WhatsApp |
| `address` | `address` | String? | EndereÃ§o |
| `city` | `city` | String? | Cidade |
| `instagram_verified` | `followedInstagram` | Boolean | Seguiu Instagram |
| `google_verified` | `ratedGoogle` | Boolean | Avaliou Google |
| `verified` | `completed` | Boolean | Lead completo |
| `social_status` | `status` | String | Status do lead |
| `partnerId` | `partnerId` | String | ID do parceiro |
| `source` | `source` | String | Origem do lead |

### **Campos AutomÃ¡ticos:**
- `id`: CUID automÃ¡tico
- `createdAt`: Timestamp de criaÃ§Ã£o
- `updatedAt`: Timestamp de atualizaÃ§Ã£o
- `ipAddress`: IP do usuÃ¡rio
- `userAgent`: User agent do navegador

---

## ğŸ”„ **Fluxo de Funcionamento**

### **1. CriaÃ§Ã£o de Lead:**
```
Frontend â†’ POST/GET â†’ API â†’ Prisma â†’ Banco â†’ NotificaÃ§Ã£o Admin
```

### **2. AtualizaÃ§Ã£o Social:**
```
Frontend â†’ PATCH â†’ API â†’ Prisma â†’ Banco â†’ Lead Atualizado
```

### **3. Fallback AutomÃ¡tico:**
```
POST falha â†’ GET fallback â†’ Imagem PNG â†’ Lead criado
```

---

## ğŸ¯ **Casos de Uso**

### **CenÃ¡rio A: FormulÃ¡rio Web Normal**
- **MÃ©todo:** POST com JSON
- **Dados:** Completos + verificaÃ§Ã£o social
- **Resposta:** Lead criado com ID

### **CenÃ¡rio B: Captive Portal Mikrotik**
- **MÃ©todo:** GET com query params
- **Dados:** BÃ¡sicos + verificaÃ§Ã£o social
- **Resposta:** Imagem PNG (sucesso)

### **CenÃ¡rio C: AtualizaÃ§Ã£o de VerificaÃ§Ã£o**
- **MÃ©todo:** PATCH para lead existente
- **Dados:** Apenas campos de verificaÃ§Ã£o
- **Resposta:** Lead atualizado

---

## ğŸ›¡ï¸ **ValidaÃ§Ãµes e SeguranÃ§a**

### **ValidaÃ§Ãµes ObrigatÃ³rias:**
- âœ… Nome, WhatsApp, EndereÃ§o, Cidade
- âœ… Parceiro deve existir e estar ativo
- âœ… WhatsApp Ãºnico por lead

### **Tratamento de Erros:**
- âŒ Dados obrigatÃ³rios faltando â†’ 400 Bad Request
- âŒ Parceiro nÃ£o encontrado â†’ 404 Not Found
- âŒ Erro interno â†’ 500 Internal Server Error

### **SeguranÃ§a:**
- ğŸ”’ ValidaÃ§Ã£o de parceiro ativo
- ğŸ”’ SanitizaÃ§Ã£o de dados de entrada
- ğŸ”’ Logs detalhados para auditoria

---

## ğŸ“Š **Exemplos de Uso**

### **Exemplo 1: Criar Lead Completo**
```bash
POST /api/leads
Content-Type: application/json

{
  "name": "JoÃ£o Silva",
  "whatsapp": "11999999999",
  "address": "Rua das Flores, 123",
  "city": "SÃ£o Paulo",
  "partnerId": "parceiro-123",
  "instagram_verified": true,
  "google_verified": true,
  "verified": true
}
```

**Resposta:**
```json
{
  "id": "lead_abc123",
  "name": "JoÃ£o Silva",
  "whatsapp": "11999999999",
  "address": "Rua das Flores, 123",
  "city": "SÃ£o Paulo",
  "partnerId": "parceiro-123",
  "followedInstagram": true,
  "ratedGoogle": true,
  "completed": true,
  "status": "completed",
  "createdAt": "2024-01-15T10:30:00Z"
}
```

### **Exemplo 2: Atualizar VerificaÃ§Ã£o Social**
```bash
PATCH /api/leads/lead-456/social
Content-Type: application/json

{
  "instagram_verified": true,
  "google_verified": false,
  "social_status": "instagram_completed"
}
```

**Resposta:**
```json
{
  "id": "lead-456",
  "name": "Maria Santos",
  "followedInstagram": true,
  "ratedGoogle": false,
  "status": "instagram_completed",
  "updatedAt": "2024-01-15T11:00:00Z"
}
```

### **Exemplo 3: Hotspot Mikrotik**
```bash
GET /api/leads?name=Maria&whatsapp=11888888888&address=Rua B&city=SP&partnerId=hotspot-mk&instagram_verified=true
```

**Resposta:** Imagem PNG 1x1 transparente (sucesso)

---

## ğŸ”§ **ConfiguraÃ§Ã£o TÃ©cnica**

### **DependÃªncias:**
- **Next.js 14** - Framework da API
- **Prisma ORM** - Banco de dados
- **PostgreSQL** - Banco principal
- **Node.js** - Runtime

### **VariÃ¡veis de Ambiente:**
```env
DATABASE_URL="postgresql://usuario:senha@localhost:5432/navegnet"
NEXTAUTH_SECRET="chave-secreta-jwt"
NEXTAUTH_URL="https://navegnetparceiros.com.br"
```

### **Deploy:**
- **Vercel** - Hospedagem
- **GitHub** - Versionamento
- **Prisma** - Migrations automÃ¡ticas

---

## ğŸ“ˆ **Monitoramento e Logs**

### **Logs AutomÃ¡ticos:**
- ğŸš€ InÃ­cio de cada requisiÃ§Ã£o
- ğŸ“‹ Dados recebidos
- âœ… Sucessos e IDs criados
- âŒ Erros e stack traces
- ğŸ” Buscas por parceiros

### **MÃ©tricas:**
- Leads criados por fonte
- Taxa de sucesso por endpoint
- Tempo de resposta
- Erros por tipo

---

## ğŸš€ **ImplementaÃ§Ã£o no Banco**

### **1. Estrutura da Tabela Lead:**
```sql
CREATE TABLE "Lead" (
  "id" TEXT NOT NULL,
  "name" TEXT NOT NULL,
  "whatsapp" TEXT NOT NULL,
  "address" TEXT,
  "city" TEXT,
  "followedInstagram" BOOLEAN NOT NULL DEFAULT false,
  "ratedGoogle" BOOLEAN NOT NULL DEFAULT false,
  "completed" BOOLEAN NOT NULL DEFAULT false,
  "ipAddress" TEXT,
  "userAgent" TEXT,
  "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
  "partnerId" TEXT NOT NULL,
  "email" TEXT,
  "notes" TEXT,
  "priority" TEXT NOT NULL DEFAULT 'medium',
  "source" TEXT NOT NULL DEFAULT 'qr_code',
  "status" TEXT NOT NULL DEFAULT 'new',
  "updatedAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
  
  CONSTRAINT "Lead_pkey" PRIMARY KEY ("id")
);
```

### **2. Ãndices Recomendados:**
```sql
CREATE INDEX "Lead_whatsapp_idx" ON "Lead"("whatsapp");
CREATE INDEX "Lead_partnerId_idx" ON "Lead"("partnerId");
CREATE INDEX "Lead_createdAt_idx" ON "Lead"("createdAt");
CREATE INDEX "Lead_status_idx" ON "Lead"("status");
CREATE INDEX "Lead_source_idx" ON "Lead"("source");
```

### **3. Relacionamentos:**
```sql
-- Lead pertence a um Partner
ALTER TABLE "Lead" ADD CONSTRAINT "Lead_partnerId_fkey" 
FOREIGN KEY ("partnerId") REFERENCES "Partner"("id") ON DELETE RESTRICT ON UPDATE CASCADE;
```

---

## ğŸ” **Testes e ValidaÃ§Ã£o**

### **1. Teste de CriaÃ§Ã£o:**
```bash
curl -X POST https://navegnetparceiros.com.br/api/leads \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Teste API",
    "whatsapp": "11977777777",
    "address": "Rua Teste",
    "city": "SP",
    "partnerId": "teste-123"
  }'
```

### **2. Teste de AtualizaÃ§Ã£o:**
```bash
curl -X PATCH https://navegnetparceiros.com.br/api/leads/LEAD_ID/social \
  -H "Content-Type: application/json" \
  -d '{
    "instagram_verified": true
  }'
```

### **3. Teste de Hotspot:**
```bash
curl "https://navegnetparceiros.com.br/api/leads?name=Teste&whatsapp=11966666666&address=Rua A&city=SP&partnerId=hotspot-mk"
```

---

## ğŸ“ **Notas de ImplementaÃ§Ã£o**

### **1. Compatibilidade:**
- âœ… **Campos legados** mantidos para compatibilidade
- âœ… **Fallbacks automÃ¡ticos** para diferentes cenÃ¡rios
- âœ… **MÃºltiplos formatos** de entrada (JSON, Form, Query)

### **2. Performance:**
- ğŸš€ **CriaÃ§Ã£o automÃ¡tica** de parceiros
- ğŸš€ **Ãndices otimizados** no banco
- ğŸš€ **Logs estruturados** para monitoramento

### **3. Escalabilidade:**
- ğŸ“ˆ **Suporte a mÃºltiplos** parceiros
- ğŸ“ˆ **Sistema de notificaÃ§Ãµes** para admins
- ğŸ“ˆ **Auditoria completa** de todas as operaÃ§Ãµes

---

## ğŸ†˜ **Suporte e Contato**

### **Para DÃºvidas TÃ©cnicas:**
- ğŸ“§ Email: suporte@navegnet.com.br
- ğŸ“± WhatsApp: (11) 99999-9999
- ğŸŒ Site: https://navegnetparceiros.com.br

### **DocumentaÃ§Ã£o Adicional:**
- ğŸ“š Prisma Docs: https://www.prisma.io/docs
- ğŸ“š Next.js API: https://nextjs.org/docs/api-routes
- ğŸ“š PostgreSQL: https://www.postgresql.org/docs

---

## ğŸ“„ **VersÃ£o e HistÃ³rico**

**VersÃ£o:** 1.0.0  
**Data:** Janeiro 2024  
**Autor:** Equipe Navegnet  
**Ãšltima AtualizaÃ§Ã£o:** 15/01/2024

### **Changelog:**
- âœ… **v1.0.0** - ImplementaÃ§Ã£o inicial da API
- âœ… **v1.1.0** - AdiÃ§Ã£o de campos de verificaÃ§Ã£o social
- âœ… **v1.2.0** - Suporte a hotspot Mikrotik
- âœ… **v1.3.0** - Endpoint PATCH para atualizaÃ§Ãµes sociais

---

*Esta documentaÃ§Ã£o fornece uma visÃ£o completa da API para implementaÃ§Ã£o e manutenÃ§Ã£o por outros analistas.* ğŸ¯

