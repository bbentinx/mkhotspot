<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Navegnet ‚Äî Login Social (Hotspot)</title>
  <style>
    :root{--bg:#0b0f14;--card:#121821;--muted:#91a0b5;--brand:#47a3ff;--ok:#10b981;--warn:#f59e0b;--err:#ef4444}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:#e6edf6;font-family:Inter,system-ui,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
    .wrap{max-width:920px;margin:40px auto;padding:24px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h1{font-size:22px;margin:0 0 12px} p{color:var(--muted);margin:0 0 14px}
    .grid{display:grid;gap:14px}
    label{font-size:13px;color:#b8c2d6}
    input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:#0f141c;color:#e6edf6}
    button{cursor:pointer;border:0;border-radius:12px;padding:12px 16px;font-weight:600}
    .btn{background:linear-gradient(135deg,#47a3ff,#1f78ff);color:white}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.12);color:#e6edf6}
    .btn-ok{background:linear-gradient(135deg,#10b981,#059669);color:white}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .hidden{display:none}
    .muted{color:var(--muted);font-size:12px}
    .badge{display:inline-flex;align-items:center;gap:6px;background:#0e1622;border:1px dashed rgba(255,255,255,.15);padding:6px 10px;border-radius:999px;font-size:12px;color:#b8c2d6}
    .stepper{display:flex;gap:10px;margin:10px 0 18px}
    .dot{width:10px;height:10px;border-radius:50%;background:#334155;opacity:.5}
    .dot.active{background:#47a3ff;opacity:1}
    .status{margin-top:10px;font-size:13px}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Bem‚Äëvindo ao Wi‚ÄëFi da <strong>Navegnet</strong></h1>
    <p>Complete o passo‚Äëa‚Äëpasso. Voc√™ pode sair para seguir/avaliar e voltar ‚Äî o progresso fica salvo.</p>

    <div class="stepper" id="stepper">
      <div class="dot" data-step="1"></div>
      <div class="dot" data-step="2"></div>
      <div class="dot" data-step="3"></div>
      <div class="dot" data-step="4"></div>
    </div>

    <!-- STEP 1: Formul√°rio -->
    <section id="step1" class="grid">
      <label>Nome
        <input id="name" autocomplete="name" placeholder="Seu nome" />
      </label>
      <label>WhatsApp
        <input id="whatsapp" inputmode="numeric" placeholder="(xx) xxxxx-xxxx" />
      </label>
      <div class="row">
        <label style="flex:1">Endere√ßo
          <input id="address" placeholder="Rua, n¬∫" />
        </label>
        <label style="flex:1">Cidade
          <input id="city" placeholder="Cidade" />
        </label>
      </div>
      <div class="row">
        <button class="btn" id="btnProsseguir">Prosseguir</button>
        <button class="btn-ghost" id="btnSalvar">Salvar e continuar depois</button>
      </div>
      <div class="status" id="status1"></div>
    </section>

    <!-- STEP 2: Instagram -->
    <section id="step2" class="grid hidden">
      <p class="muted">Siga nosso Instagram. Voc√™ pode sair e voltar ‚Äî depois clique em <em>J√° segui</em>.</p>
      <div class="row">
        <a class="btn" id="btnAbrirInsta" href="#" target="_blank" rel="noopener noreferrer">Abrir Instagram</a>
        <button class="btn-ok" id="btnJaSegui">‚úÖ J√° segui</button>
      </div>
      <div class="status" id="status2"></div>
    </section>

    <!-- STEP 3: Google Review -->
    <section id="step3" class="grid hidden">
      <p class="muted">Avalie no Google. Ao voltar, clique em <em>J√° avaliei</em> para finalizar.</p>
      <div class="row">
        <a class="btn" id="btnAbrirGoogle" href="#" target="_blank" rel="noopener noreferrer">Abrir avalia√ß√£o</a>
        <button class="btn-ok" id="btnJaAvaliei">‚úÖ J√° avaliei</button>
      </div>
      <div class="status" id="status3"></div>
    </section>

    <!-- STEP 4: Finaliza√ß√£o/libera√ß√£o -->
    <section id="step4" class="grid hidden">
      <p class="muted">Concluindo‚Ä¶ sua conex√£o ser√° liberada e os dados enviados.</p>
      <div class="badge" id="badgeConn">üîí Aguardando libera√ß√£o</div>
      <div class="status" id="status4"></div>
      <div class="row">
        <button class="btn-ghost" id="btnRecarregar">Recarregar esta p√°gina</button>
      </div>
    </section>
  </div>
</div>

<script>
// ====== CONFIG ======
const API_BASE_URL = window.API_BASE_URL || 'https://navegnetparceiros.com.br/api';
const PARTNER_SLUG  = window.PARTNER_SLUG || 'hotspot-mk';
const INSTA_URL     = 'https://www.instagram.com/navegnet/'; // URL real do Instagram
const GOOGLE_REVIEW = 'https://g.page/r/CZGbfiDK2IZgEBM/review'; // j√° usado por voc√™
const DEFAULT_LOGIN_FALLBACK = 'http://10.5.50.1/login'; // Mikrotik padr√£o (altere se necess√°rio)

// Fun√ß√£o para detectar nova conex√£o
function isNewConnection() {
  const lastConnectionTime = localStorage.getItem('last_connection_time');
  const currentTime = Date.now();
  const CONNECTION_TIMEOUT = 5 * 60 * 1000; // 5 minutos
  
  if (!lastConnectionTime) {
    return true;
  }
  
  const timeDiff = currentTime - Number(lastConnectionTime);
  return timeDiff > CONNECTION_TIMEOUT;
}

// Fun√ß√£o para limpar localStorage de forma abrangente
function clearAllPendingStates() {
  const keysToRemove = [
    'automatic_send_data', 
    'automatic_send_timestamp', 
    'automatic_send_configured', 
    'data_pending_send', 
    'automatic_send_on_return', 
    'navegnet_social_actions', 
    'instagram_action_data', 
    'google_action_data', 
    'pending_lead_data',
    'instagram_verified', 
    'google_verified', 
    'navegnet_current_step',
    'navegnet_form_data',
    'navegnet_lead_id',
    'instagram_redirected',
    'instagram_redirect_time',
    'google_redirected',
    'google_redirect_time'
  ];
  
  keysToRemove.forEach(k => localStorage.removeItem(k));
  
  // Limpar campos do formul√°rio
  ['#name', '#whatsapp', '#address', '#city'].forEach(id => {
    const el = $(id);
    if (el) el.value = '';
  });
}

// Fun√ß√£o para resetar completamente o estado
function resetCompleteState() {
  clearAllPendingStates();
  currentStep = 1;
  leadId = null;
  showStep(1);
  msg('#status1', '', '');
  msg('#status2', '', '');
  msg('#status3', '', '');
  msg('#status4', '', '');
  $('#badgeConn').textContent = 'üîí Aguardando libera√ß√£o';
}

// ====== ESTADO ======
let currentStep = 1;
let leadId = null;
let isInHotspot = false; // detectado adiante

// ====== UTIL ======
const $ = sel => document.querySelector(sel);
function setLoading(b){ document.body.style.pointerEvents = b? 'none':'auto'; document.body.style.opacity = b? .85:1 }
function showStep(n){ currentStep=n; localStorage.setItem('navegnet_current_step', String(n));
  ['#step1','#step2','#step3','#step4'].forEach((id,i)=>{ const el=$(id); if(!el) return; (i+1)===n? el.classList.remove('hidden'): el.classList.add('hidden') });
  document.querySelectorAll('.dot').forEach(dot=>{ dot.classList.toggle('active', Number(dot.dataset.step)<=n) })
}
function msg(elId,text,cls=''){ const el=$(elId); if(!el) return; el.innerHTML = text? `<span class="${cls}">${text}</span>` : '' }
function getUrlParam(k){ const usp = new URLSearchParams(location.search); return usp.get(k) }
function detectDevice(){ const ua=navigator.userAgent.toLowerCase();
  const isAndroid=/android/.test(ua), isIOS=/iphone|ipad|ipod/.test(ua); return {device: isAndroid?'Android': isIOS?'iOS':'Desktop'} }
function saveFormLocal(data){ localStorage.setItem('navegnet_form_data', JSON.stringify(data)) }
// Modificar restoreSavedState para evitar duplicidade de showStep
function restoreSavedState(){ 
  const step = Number(localStorage.getItem('navegnet_current_step')||'1'); 
  const fdStr = localStorage.getItem('navegnet_form_data'); 
  const savedLead = localStorage.getItem('navegnet_lead_id');
  
  if(fdStr){ 
    try{ 
      const f = JSON.parse(fdStr); 
      ['name','whatsapp','address','city'].forEach(k => { 
        if(f[k]){ 
          document.getElementById(k).value = f[k] 
        } 
      }); 
    }catch(e){}
  }
  
  if(savedLead) leadId = savedLead; 
  
  // Remover chamada de showStep daqui
  // showStep ser√° chamado apenas no boot
}

// ====== DETEC√á√ÉO CAPTIVE ======
(function detectCaptive(){
  // Mikrotik normalmente injeta link-login e link-orig na URL
  const linkLogin = getUrlParam('link-login');
  const chapId    = getUrlParam('chap-id');
  const chapChal  = getUrlParam('chap-challenge');
  isInHotspot = Boolean(linkLogin || chapId || chapChal);
  console.log('Hotspot?', isInHotspot, {linkLogin, chapId});
})();

// ====== STEP 1 ======
$('#btnProsseguir').addEventListener('click', async () => {
  setLoading(true);
  try{
    const formData = {
      name: $('#name').value.trim(),
      whatsapp: $('#whatsapp').value.trim(),
      address: $('#address').value.trim(),
      city: $('#city').value.trim(),
      partnerId: PARTNER_SLUG,
      source: 'hotspot_mikrotik',
      device: detectDevice().device,
      timestamp: new Date().toISOString()
    };
    saveFormLocal(formData);

    // Valida√ß√£o de WhatsApp
    const digits = formData.whatsapp.replace(/\D/g,'');
    if(digits.length < 10){
      msg('#status1','Informe um WhatsApp v√°lido.','err'); 
      setLoading(false);
      return;
    }

    if(!formData.name || !formData.whatsapp || !formData.address || !formData.city){
      msg('#status1','Por favor, preencha todos os campos.','err'); return;
    }

    // Dentro do captive: salva dados para envio posterior
    if(isInHotspot){
      leadId = 'hotspot_'+Date.now();
      localStorage.setItem('navegnet_lead_id', leadId);
      
      // Salvar dados para envio posterior
      const pendingData = {
        ...formData,
        instagram_verified: false,
        google_verified: false,
        verified: false
      };
      localStorage.setItem('pending_lead_data', JSON.stringify(pendingData));
      
      showStep(2); 
      msg('#status1','Dados salvos localmente. Continue para as a√ß√µes.','ok'); 
      setLoading(false);
      return;
    }

    // Fora do captive: cria lead imediatamente
    const res = await fetch(`${API_BASE_URL}/leads`,{
      method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'}, mode:'cors', body: JSON.stringify(formData)
    });
    if(!res.ok){ const err = await safeJson(res); throw new Error(err?.error||`HTTP ${res.status}`) }
    const lead = await res.json(); leadId = String(lead.id); localStorage.setItem('navegnet_lead_id', leadId);
    showStep(2); msg('#status1','Lead criado com sucesso.','ok');
  }catch(e){
    console.warn('Erro ao criar lead (seguindo offline):', e.message);
    leadId = 'offline_'+Date.now(); localStorage.setItem('navegnet_lead_id', leadId);
    showStep(2); msg('#status1','Sem internet: vamos continuar e enviar depois.','warn');
  }finally{ setLoading(false) }
});

$('#btnSalvar').addEventListener('click', ()=>{ const f = collectForm(); saveFormLocal(f); msg('#status1','Progresso salvo. Voc√™ pode voltar depois.','ok') })

function collectForm(){ return { name: $('#name').value.trim(), whatsapp: $('#whatsapp').value.trim(), address: $('#address').value.trim(), city: $('#city').value.trim(), partnerId: PARTNER_SLUG, source:'hotspot_mikrotik', device: detectDevice().device, timestamp: new Date().toISOString() } }

// ====== STEP 2 ‚Äî Instagram ======
$('#btnAbrirInsta').href = INSTA_URL;
$('#btnAbrirInsta').addEventListener('click', ()=>{
  localStorage.setItem('instagram_redirected','true');
  localStorage.setItem('instagram_redirect_time', String(Date.now()));
  msg('#status2','Abrindo Instagram‚Ä¶ volte e clique ‚ÄúJ√° segui‚Äù.','muted')
});
$('#btnJaSegui').addEventListener('click', async ()=>{
  setLoading(true);
  try {
    localStorage.setItem('instagram_verified','true');
    captureSocial('instagram',{ action_type:'confirm_click' });
    
    // Atualizar dados pendentes com verifica√ß√£o do Instagram
    const pendingDataStr = localStorage.getItem('pending_lead_data');
    if (pendingDataStr) {
      const pendingData = JSON.parse(pendingDataStr);
      pendingData.instagram_verified = true;
      localStorage.setItem('pending_lead_data', JSON.stringify(pendingData));
    }
    
    msg('#status2','‚úÖ Instagram verificado! Prossiga para a avalia√ß√£o no Google.','ok');
    showStep(3);
    
    // Tentar atualizar via API se n√£o estiver no hotspot
    if (!isInHotspot && leadId && !leadId.startsWith('hotspot_')) {
      await safeUpdateSocial('instagram');
    }
  } finally {
    setLoading(false);
  }
});

// ====== STEP 3 ‚Äî Google Review ======
$('#btnAbrirGoogle').href = GOOGLE_REVIEW;
$('#btnAbrirGoogle').addEventListener('click', ()=>{
  localStorage.setItem('google_redirected','true');
  localStorage.setItem('google_redirect_time', String(Date.now()));
  msg('#status3','Abrindo avalia√ß√£o‚Ä¶ volte e clique ‚ÄúJ√° avaliei‚Äù.','muted')
});
$('#btnJaAvaliei').addEventListener('click', async ()=>{
  setLoading(true);
  try {
    localStorage.setItem('google_verified','true');
    captureSocial('google',{ action_type:'confirm_click' });
    
    // Atualizar dados pendentes com verifica√ß√£o do Google
    const pendingDataStr = localStorage.getItem('pending_lead_data');
    if (pendingDataStr) {
      const pendingData = JSON.parse(pendingDataStr);
      pendingData.google_verified = true;
      pendingData.verified = true; // Marcar como completo
      localStorage.setItem('pending_lead_data', JSON.stringify(pendingData));
    }
    
    msg('#status3','‚úÖ Google verificado! Finalizando e liberando a internet‚Ä¶','ok');
    
    // Tentar atualizar via API se n√£o estiver no hotspot
    if (!isInHotspot && leadId && !leadId.startsWith('hotspot_')) {
      await safeUpdateSocial('google');
    }
    
    await finalizeAndUnlock();
  } finally {
    setLoading(false);
  }
});

// ====== FINALIZA√á√ÉO ======
async function finalizeAndUnlock(){
  setLoading(true); showStep(4); msg('#status4','Preparando dados‚Ä¶','muted');

  // 1) Garantir que temos payload salvo para envio autom√°tico assim que a internet liberar
  const saved = saveAllDataForAutomaticSend();
  if(saved){ msg('#status4','Dados prontos para envio autom√°tico.','ok') }

  // 2) Configurar o gatilho para enviar quando a p√°gina voltar com internet
  setupAutomaticDataSendForReturn();

  // 3) Liberar no Mikrotik (usando link-login real)
  msg('#badgeConn','Redirecionando para libera√ß√£o‚Ä¶','warn');
  setTimeout(()=> liberarNoCaptive(), 800);
}

// ====== EXPIRA√á√ÉO DE ESTADO PENDENTE ======
function clearExpiredPendingState() {
  const EXPIRATION_TIME = 24 * 60 * 60 * 1000; // 24 horas
  
  // Verificar dados de envio autom√°tico
  const autoSendData = localStorage.getItem('automatic_send_data');
  const autoSendTimestamp = localStorage.getItem('automatic_send_timestamp');
  
  if (autoSendData && autoSendTimestamp) {
    const currentTime = Date.now();
    const savedTime = Number(autoSendTimestamp);
    
    if (currentTime - savedTime > EXPIRATION_TIME) {
      console.warn('Estado de envio autom√°tico expirado. Limpando dados.');
      
      // Limpar todos os dados relacionados
      ['automatic_send_data', 'automatic_send_timestamp', 
       'automatic_send_configured', 'data_pending_send', 
       'automatic_send_on_return', 'navegnet_social_actions',
       'instagram_action_data', 'google_action_data', 
       'pending_lead_data', 'instagram_verified', 
       'google_verified', 'navegnet_current_step'].forEach(k => {
        localStorage.removeItem(k);
      });
      
      // Resetar para o primeiro passo
      showStep(1);
      msg('#status4', 'Sess√£o expirada. Por favor, reinicie o processo.', 'warn');
      return true;
    }
  }
  
  return false;
}

// Modificar fun√ß√£o de envio para salvar timestamp
function saveAutomaticSendData(data) {
  localStorage.setItem('automatic_send_data', JSON.stringify(data));
  localStorage.setItem('automatic_send_timestamp', String(Date.now()));
}

// Modificar saveAllDataForAutomaticSend para usar novo m√©todo
function saveAllDataForAutomaticSend(){
  // Coleta segura: usa campos, localStorage e fallbacks
  let fd = collectForm();
  if(!fd.name || !fd.whatsapp || !fd.address || !fd.city){
    try{ 
      const cached = JSON.parse(localStorage.getItem('navegnet_form_data')||'{}'); 
      fd = {...cached, partnerId:PARTNER_SLUG, source:'hotspot_mikrotik', device: detectDevice().device, timestamp:new Date().toISOString() } 
    }catch(e){}
  }
  if(!fd.name || !fd.whatsapp || !fd.address || !fd.city){ 
    console.error('Sem dados v√°lidos para envio'); 
    return false 
  }

  const socialActions = JSON.parse(localStorage.getItem('navegnet_social_actions')||'[]');
  const autoData = { ...fd,
    instagram_verified: localStorage.getItem('instagram_verified')==='true',
    google_verified:    localStorage.getItem('google_verified')==='true',
    socialActions
  };
  
  // Usar novo m√©todo de salvar com timestamp
  saveAutomaticSendData(autoData);
  
  localStorage.setItem('automatic_send_configured','true');
  return true;
}

function setupAutomaticDataSendForReturn(){
  localStorage.setItem('data_pending_send','true');
  localStorage.setItem('automatic_send_on_return','true');
}

function buildReturnUrl(){
  const url = new URL(location.href);
  url.searchParams.set('send_pending_data','true');
  url.searchParams.set('source','hotspot_mikrotik');
  url.searchParams.delete('link-login'); // evita loops
  url.searchParams.delete('link-orig');
  url.searchParams.delete('chap-id');
  url.searchParams.delete('chap-challenge');
  return url.toString();
}

function liberarNoCaptive(){
  const linkLogin = getUrlParam('link-login');
  const loginEndpoint = linkLogin || DEFAULT_LOGIN_FALLBACK;
  const USER='free', PASS='free'; // TODO: se usar outro usu√°rio/perfil, ajuste aqui
  const dst = buildReturnUrl();
  const authUrl = `${loginEndpoint}?username=${encodeURIComponent(USER)}&password=${encodeURIComponent(PASS)}&dst=${encodeURIComponent(dst)}`;
  console.log('Liberando no Mikrotik ‚Üí', authUrl);
  location.replace(authUrl);
}

// ====== ENVIO QUANDO VOLTAR DA LIBERA√á√ÉO ======
// Fun√ß√£o de retry com backoff exponencial
async function retryAutomaticSend(maxRetries = 3, baseDelay = 1000) {
  // Mostrar status de tentativa
  showStep(4);
  msg('#status4', 'Verificando conex√£o e enviando dados...', 'muted');
  
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      msg('#status4', `Tentativa ${attempt} de ${maxRetries}...`, 'muted');
      
      const result = await executeAutomaticDataSend(true);
      
      // Sucesso!
      msg('#status4', '‚úÖ Dados enviados com sucesso!', 'ok');
      $('#badgeConn').textContent = '‚úÖ Conex√£o liberada';
      
      // Aguardar um pouco antes de resetar
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      // Resetar completamente para novo usu√°rio
      resetCompleteState();
      msg('#status1', 'Sistema pronto para novo cadastro', 'ok');
      
      return true;
    } catch (error) {
      console.warn(`Tentativa ${attempt} de envio falhou:`, error);
      
      if (attempt < maxRetries) {
        // Backoff exponencial
        const delay = baseDelay * Math.pow(2, attempt - 1);
        msg('#status4', `Tentativa ${attempt} falhou. Aguardando ${delay/1000}s para pr√≥xima tentativa...`, 'warn');
        await new Promise(resolve => setTimeout(resolve, delay));
      }
    }
  }
  
  // Falha ap√≥s todas as tentativas
  msg('#status4', '‚ùå Falha no envio ap√≥s m√∫ltiplas tentativas.', 'err');
  $('#badgeConn').textContent = '‚ùå Erro no envio';
  
  // Oferecer op√ß√£o de tentar novamente
  setTimeout(() => {
    msg('#status4', 'Clique em "Recarregar" para tentar novamente.', 'warn');
  }, 2000);
  
  return false;
}

// Modificar checkAndSendPendingDataOnLoad para verificar expira√ß√£o
function checkAndSendPendingDataOnLoad() {
  // Primeiro, limpar estado expirado
  const wasExpired = clearExpiredPendingState();
  
  if (wasExpired) {
    return; // Estado j√° foi limpo
  }
  
  const should = getUrlParam('send_pending_data') === 'true' && 
                 getUrlParam('source') === 'hotspot_mikrotik';
  
  if (!should) { 
    // Verificar se h√° dados pendentes mesmo sem par√¢metros na URL
    const hasPendingData = localStorage.getItem('automatic_send_data') || 
                          localStorage.getItem('pending_lead_data');
    
    if (!hasPendingData) {
      return;
    }
    
    // Se h√° dados pendentes mas n√£o √© a URL de retorno, tentar enviar mesmo assim
    console.log('Dados pendentes encontrados. Tentando enviar...');
    setTimeout(() => retryAutomaticSend(), 2000);
    return; 
  }
  
  console.log('P√°gina voltou da libera√ß√£o. For√ßando envio autom√°tico‚Ä¶');
  
  // Usar m√©todo de retry
  setTimeout(() => retryAutomaticSend(), 1200);
}

// Modificar executeAutomaticDataSend para ser mais robusto
async function executeAutomaticDataSend(forceIgnoreCaptive = false) {
  // Priorizar automatic_send_data, depois pending_lead_data
  let raw = localStorage.getItem('automatic_send_data');
  let isPendingData = false;
  
  if (!raw) {
    raw = localStorage.getItem('pending_lead_data');
    isPendingData = true;
  }
  
  if (!raw) { 
    console.warn('Nada para enviar'); 
    return; 
  }
  
  let data = JSON.parse(raw);
  
  // Garantir que os campos de verifica√ß√£o estejam presentes
  if (!data.hasOwnProperty('instagram_verified')) {
    data.instagram_verified = localStorage.getItem('instagram_verified') === 'true';
  }
  if (!data.hasOwnProperty('google_verified')) {
    data.google_verified = localStorage.getItem('google_verified') === 'true';
  }
  if (!data.hasOwnProperty('verified')) {
    data.verified = data.instagram_verified && data.google_verified;
  }
  
  // Adicionar campos obrigat√≥rios se n√£o existirem
  if (!data.partnerId) data.partnerId = PARTNER_SLUG;
  if (!data.source) data.source = 'hotspot_mikrotik';
  if (!data.device) data.device = detectDevice().device;
  if (!data.timestamp) data.timestamp = new Date().toISOString();
  
  console.log('Enviando dados para API:', data);
  
  // Timeout para evitar bloqueio permanente
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 segundos
  
  try {
    const resp = await fetch(`${API_BASE_URL}/leads`, {
      method: 'POST', 
      headers: {'Content-Type': 'application/json'}, 
      mode: 'cors', 
      body: JSON.stringify(data),
      signal: controller.signal
    });
    
    clearTimeout(timeoutId);
    
    if (!resp.ok) {
      throw new Error(`Erro no envio: ${resp.status}`);
    }
    
    const created = await resp.json();
    leadId = String(created.id);
    localStorage.setItem('navegnet_lead_id', leadId);
    
    // PATCH /leads/{id}/social ‚Äî envia booleans corretos
    const ig = data.instagram_verified || localStorage.getItem('instagram_verified')==='true';
    const gg = data.google_verified || localStorage.getItem('google_verified')==='true';
    
    if(leadId && (!leadId.startsWith('hotspot_') && !leadId.startsWith('offline_'))){
      try{
        const patchResponse = await fetch(`${API_BASE_URL}/leads/${leadId}/social`,{
          method:'PATCH', 
          headers:{'Content-Type':'application/json','Accept':'application/json'}, 
          mode:'cors',
          body: JSON.stringify({ 
            instagram_verified: ig, 
            google_verified: gg,
            verified: ig && gg,
            social_status: ig && gg ? 'completed' : (ig ? 'instagram_completed' : (gg ? 'google_completed' : 'pending')),
            completion_percentage: (ig && gg) ? 100 : (ig || gg ? 50 : 0)
          })
        });
        
        if (patchResponse.ok) {
          console.log('Verifica√ß√µes sociais atualizadas com sucesso');
        }
      }catch(e){ 
        console.warn('Falha no PATCH social (prosseguir mesmo assim):', e.message) 
      }
    }

    // Limpeza completa ap√≥s sucesso
    clearAllPendingStates();
    
    msg('#status4','‚úÖ Dados enviados com sucesso! Conex√£o liberada.','ok'); 
    $('#badgeConn').textContent='‚úÖ Conex√£o liberada';
    
    // Resetar para novo usu√°rio ap√≥s 3 segundos
    setTimeout(() => {
      resetCompleteState();
      msg('#status1', 'Pronto para novo cadastro', 'ok');
    }, 3000);
    
    return created;
  } catch (err) {
    clearTimeout(timeoutId);
    
    // Fallback: salvar para tentar de novo depois
    if (raw) { 
      localStorage.setItem('pending_lead_data', raw);
      msg('#status4', 'Falha no envio. Vamos tentar novamente em seguida.', 'warn');
    }
    
    throw err; // Propagar para retry
  }
}

// ====== CAPTURA SOCIAL (manual + log local) ======
function captureSocial(action, details={}){
  const payload = { action, timestamp:new Date().toISOString(), device:detectDevice().device, userAgent:navigator.userAgent, details };
  const arr = JSON.parse(localStorage.getItem('navegnet_social_actions')||'[]'); arr.push(payload);
  localStorage.setItem('navegnet_social_actions', JSON.stringify(arr));
}

async function safeUpdateSocial(action){
  if(!leadId || leadId.startsWith('hotspot_')|| leadId.startsWith('offline_')|| isInHotspot) return;
  
  try{ 
    const updateData = {
      action,
      [`${action}_verified`]: true
    };
    
    // Adicionar status baseado na a√ß√£o
    if (action === 'instagram') {
      updateData.social_status = 'instagram_completed';
    } else if (action === 'google') {
      updateData.social_status = 'google_completed';
      updateData.verified = true;
    }
    
    const response = await fetch(`${API_BASE_URL}/leads/${leadId}/social`,{ 
      method:'PATCH', 
      headers:{'Content-Type':'application/json','Accept':'application/json'}, 
      mode:'cors', 
      body: JSON.stringify(updateData) 
    });
    
    if (response.ok) {
      console.log(`A√ß√£o ${action} atualizada com sucesso`);
    }
  }catch(e){ 
    console.warn(`Erro ao atualizar a√ß√£o ${action}:`, e.message);
  }
}

// ====== RESUME AUTOM√ÅTICO AP√ìS VOLTAR DO INSTAGRAM/GOOGLE ======
function handleReturnFromSocial(){
  // Instagram
  if(currentStep===2){ const was = localStorage.getItem('instagram_redirected')==='true'; const t= Number(localStorage.getItem('instagram_redirect_time')||0); if(was && (Date.now()-t<5*60*1000)){ $('#btnJaSegui').textContent='‚úÖ J√° segui (confirmar)'; localStorage.removeItem('instagram_redirected'); localStorage.removeItem('instagram_redirect_time') } }
  // Google
  if(currentStep===3){ const was = localStorage.getItem('google_redirected')==='true'; const t= Number(localStorage.getItem('google_redirect_time')||0); if(was && (Date.now()-t<5*60*1000)){ $('#btnJaAvaliei').textContent='‚úÖ J√° avaliei (finalizar)'; localStorage.removeItem('google_redirected'); localStorage.removeItem('google_redirect_time') } }
}
['visibilitychange','focus'].forEach(evt=> window.addEventListener(evt, ()=>{ if(!document.hidden) handleReturnFromSocial() }))

// ====== HELPERS ======
async function safeJson(res){ try{ return await res.json() }catch(_){ return null } }

// ====== M√ÅSCARA WHATSAPP ======
$('#whatsapp').addEventListener('input',(e)=>{
  let v=e.target.value.replace(/\D/g,'');
  if(v.length>=11) v=v.replace(/(\d{2})(\d{5})(\d{4})/,'($1) $2-$3');
  else if(v.length>=7) v=v.replace(/(\d{2})(\d{4})(\d{0,4})/,'($1) $2-$3');
  else if(v.length>=3) v=v.replace(/(\d{2})(\d{0,5})/,'($1) $2');
  e.target.value=v;
});

// ====== BOOT ======
// Verificar se √© uma nova conex√£o e limpar estado se necess√°rio
if (isNewConnection()) {
  console.log('Nova conex√£o detectada. Limpando estado anterior...');
  resetCompleteState();
  localStorage.setItem('last_connection_time', String(Date.now()));
} else {
  restoreSavedState();
  showStep(Number(localStorage.getItem('navegnet_current_step')||1));
}

window.addEventListener('load', ()=> setTimeout(()=>{ 
  handleReturnFromSocial(); 
  if(!isInHotspot) trySendPendingLegacy(); 
  // Atualizar timestamp de conex√£o
  localStorage.setItem('last_connection_time', String(Date.now()));
}, 800));

$('#btnRecarregar').addEventListener('click', ()=> {
  resetCompleteState();
  location.reload();
})

// Envia dados pendentes antigos (legado), fora do captive
async function trySendPendingLegacy(){
  if(isInHotspot) return; const pend = localStorage.getItem('pending_lead_data'); if(!pend) return;
  try{ const data = JSON.parse(pend); const r = await fetch(`${API_BASE_URL}/leads`,{ method:'POST', headers:{'Content-Type':'application/json'}, mode:'cors', body: JSON.stringify(data)}); if(r.ok){ localStorage.removeItem('pending_lead_data'); console.log('Pendentes enviados (legado)') } }catch(_){ }
}
if(document.readyState==='complete') checkAndSendPendingDataOnLoad(); else window.addEventListener('load', checkAndSendPendingDataOnLoad);
</script>
</body>
</html>
